{% extends 'otherLayout.html.twig' %}

{% block head %}
    {{ parent() }}
    <link rel="icon" href="{{ preload(asset('assets/img/favicon/cropped-cropped-logo-trust-and-market-32x32.png')) }}"
          sizes="32x32"/>
    <link rel="icon" href="{{ preload(asset('assets/img/favicon/cropped-cropped-logo-trust-and-market-192x192.png')) }}"
          sizes="192x192"/>
    <link rel="apple-touch-icon-precomposed"
          href="{{ preload(asset('assets/img/favicon/cropped-cropped-logo-trust-and-market-180x180.png')) }}"/>
    <meta name="msapplication-TileImage"
          content="{{ preload(asset('assets/img/favicon/cropped-cropped-logo-trust-and-market-270x270.png')) }}"/>
    <meta name="title"
          content="Trust &amp; Market | {{ include('Seo/Meta/title.html.twig', {code: 'offre-souscription'}) }}">
    <meta name="description"
          content="{{ include('Seo/Meta/description.html.twig', {code: 'offre-souscription'}) }}">
    <link rel="canonical" href="{{ absolute_url(path('app_souscription')) }}">
    <link rel="shortlink" href="{{ path('app_souscription') }}">
    {# OG CONTENT #}
    <meta property="og:title" content="Trust &amp; Market |	{{ include('Seo/Meta/title.html.twig', {code: 'offre-souscription'}) }}">
    <meta property="og:description" content="{{ include('Seo/Meta/description.html.twig', {code: 'offre-souscription'}) }}">
    <meta property="og:image" content="{{ asset('assets/img/favicon/cropped-cropped-logo-trust-and-market-270x270.png') }}">
    <meta propery="og:type" content="website">
    {# END OG CONTENT #}
{% endblock %}

{% block title %}
    Trust &amp; Market | {{ include('Seo/Meta/title.html.twig', {code: 'offre-souscription'}) }}
{% endblock %}

{% block style %}
    {{ parent() }}

    <!-- Gijgo datepicker css -->
    <link rel="stylesheet" href=" {{ asset('assets/css/gijgo-css/gijgo.min.css') }}">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"/>
    <link rel="stylesheet" href="{{ asset('toastr/toastr.min.css') }}">
    <!-- Custom css for camroll -->
    <link href="{{ asset('assets/css/camroll/camroll_slider.css') }}" rel="stylesheet" type="text/css">
    <link href="{{ asset('assets/css/custome.css') }}" rel="stylesheet">
    <link href="{{ asset('assets/css/mon-profil.css') }}" rel="stylesheet" type="text/css">
    <!-- owl carousel css -->
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.18/dist/sweetalert2.min.css" rel="stylesheet">
    <style>

        .pagination .page-item.active .page-link {
            background-color: #f17b30;
        }

        .card-deck {
            display: flex;
            flex-wrap: wrap;
            align-items: stretch;
        }

        .card {
            border-color: #ff7e10 !important;
            border-radius: 25px;
            text-align: center;
            margin: 10px;
            padding-bottom: 0.5rem;
        }

        .card[class*=border] {
            border: 2px solid #9e9e9e;
            box-shadow: none;
        }

        .card-title {
            text-decoration-line: underline;
        }

        .card-footer {
            background-color: transparent;
            border: none;
        }

        .card-footer, .btn-primary {
            border-radius: 25px !important;
            background: #008779 !important;
        }

        .container {
            position: relative;
        }

        .vertical-center {
            margin-top: 4rem;

        }

        .descriptif-border {
            border: 1px solid;
        }

        .img-fluid {
            margin: auto;
            width: 2rem;
        }

        /* For Desktop View */
        @media screen and (min-width: 1024px) {
            #dialoguons {
                width: 19%;
            }
        }

        /* For Tablet View */
        @media screen and (min-device-width: 768px)
        and (max-device-width: 1024px) {
            #dialoguons {
                width: 30%;
            }

            .playVideoButton {
                width: 70px !important;
                height: 70px !important;
            }

            .vertical-center {
                margin-top: 5rem;
            }
        }

        /* For Mobile Portrait View */
        @media screen and (max-device-width: 480px)
        and (orientation: portrait) {
            #dialoguons {
                width: 70%;
            }

            .playVideoButton {
                width: 50px !important;
                height: 50px !important;
            }

            .vertical-center {
                margin-top: 4rem;
            }

            h1 {
                font-size: xx-large;
            }
        }

        /* For Mobile Landscape View */
        @media screen and (max-device-width: 640px)
        and (orientation: landscape) {
            #dialoguons {
                width: 40%;
            }

            .playVideoButton {
                width: 50px !important;
                height: 50px !important;
            }
        }

        /* For Mobile Phones Portrait or Landscape View */
        @media screen
        and (max-device-width: 640px) {
            #dialoguons {
                width: 40%;
            }

            .playVideoButton {
                width: 50px !important;
                height: 50px !important;
            }
        }

        /* For iPhone 4 Portrait or Landscape View */
        @media screen and (min-device-width: 320px)
        and (-webkit-min-device-pixel-ratio: 2) {
            #dialoguons {
                width: 60%;
            }

            .playVideoButton {
                width: 50px !important;
                height: 50px !important;
            }
        }

        /* For iPhone 5 Portrait or Landscape View */
        @media (device-height: 568px)
        and (device-width: 320px)
        and (-webkit-min-device-pixel-ratio: 2) {
            #dialoguons {
                width: 70%;
            }

            .playVideoButton {
                width: 50px !important;
                height: 50px !important;
            }
        }

        /* For iPhone 6 and 6 plus Portrait or Landscape View */
        @media (min-device-height: 667px)
        and (min-device-width: 375px)
        and (-webkit-min-device-pixel-ratio: 3) {
            #dialoguons {
                width: 60%;
            }

            .playVideoButton {
                width: 50px !important;
                height: 50px !important;
            }
        }
    </style>
{% endblock %}

{% block header %}
    {{ parent() }}
{% endblock %}

{% block navigation %}{% endblock %}

{% block body %}
    <!--Main Layout-->
    <main class="">
        <div class="container">
            <div class="vertical-center">
                <h1 class="col-md-8 d-flex justify-content-center text-center mx-auto page-title mb-3">NOS OFFRES
                    PROFESSIONNELLES</h1>
                <div class="row justify-content-center mt-1">
                    {% for offre in offres %}
                        <div class="col-sm-6 col-md-4 mt-3 card-deck">
                            <div class="card border-success">
                                <div class="card-body">
                                    <h2 class="card-title">{{ offre.titre }}</h2>
                                    <span class="card-subtitle"><b>{{ offre.tarif|format_currency('EUR') }}</b> /mois</span>
                                    <p class="card-text">{{ offre.enteteDescriptif|raw }}</p>
                                    <hr class="descriptif-border">
                                    <p class="card-text">{{ offre.descriptif|raw }}</p>
                                </div>
                                <form method="post" action="" id="1abonnement_update">
                                    <input hidden name="tag" id="tag" value="">
                                    <input hidden name="offreId" id="offreId" value="{{ offre.id }}">
                                    <input hidden name="offreTarif" id="offreTarif" value="{{ offre.tarif }}">
                                    <input hidden name="url" id="url"
                                           value="{{ path('app_souscription_offre_payante_get', {forfait: offre.id}) }}">
                                    <input hidden name="ancienneOffreTarif" id="ancienneOffreTarif"
                                           value="{% if abonnement and abonnement|first.isAbonnementActif %}{{ abonnement|first.getOffre.tarif }}{% else %}0{% endif %}">
                                    <button type="submit" class="btn card-footer btn-primary payment-button"
                                            {% if abonnement and abonnement|first.isAbonnementActif and abonnement|first.offre == offre %}disabled{% endif %}>
                                        {% if abonnement and abonnement|first.isAbonnementActif and abonnement|first.offre == offre %}Votre offre actuelle{% else %}Choisir cette offre{% endif %}
                                    </button>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <div class="row mt-4">
                    <div class="col-md-4">
                        <img src="{{ asset('assets/images/circular-arrow.svg') }}" class="img-fluid" alt="Image 1">
                        <div class="text-center">
                            <p>Souscription<br>
                                30 jours d'essai gratuit</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <img src="{{ asset('assets/images/pigeon-bird-icon.svg') }}" class="img-fluid" alt="Image 2">
                        <div class="text-center">
                            <p>Pas d'engagement<br>
                                Vous arretez quand vous voulez.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <img src="{{ asset('assets/images/lock.svg') }}" class="img-fluid" alt="Image 3">
                        <div class="text-center">
                            <p>Experience de paiement<br>
                                securise</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-12 mt-4 text-center">
                    <a target="_blank"
                       href="{{ path('marketing_details_promo_com',{slug: 'details-des-fonctionnalites-des-abonnements'}) }}"
                       class="text-dark"><h3><u>Details sur les fonctionnalites</u></h3></a>
                </div>
            </div>

        </div>
    </main>
    <!--Main Layout-->

    {% include("partials/project.html.twig") %}
    {% include("partials/otherPagesVideoModal.html.twig") %}
{% endblock %}


{% block footer %}
    {{ parent() }}

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('toastr/toastr.min.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.18/dist/sweetalert2.all.min.js"></script>
    <script>
        $(document).ready(function () {

            document.querySelectorAll('.payment-button').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault(); // Prevent form submission
                    toastr.warning("Le paiement en ligne sera disponible bientôt.");
                });
            });

            $(document).on('submit', '#abonnement_update', function (e) {
                e.preventDefault();
                {% if is_granted('IS_AUTHENTICATED_FULLY') %}
                let formData = {};
                $(this).find("input, select, textarea").each(function (index, element) {
                    let inputName = $(this).attr("name");
                    let inputValue = $(this).val();
                    // Handle checkboxes and radio buttons separately
                    if ($(this).attr("type") === "checkbox" || $(this).attr("type") === "radio") {
                        if ($(this).is(":checked")) {
                            formData[inputName] = inputValue;
                        }
                    } else {
                        formData[inputName] = inputValue;
                    }
                });
                if (formData.ancienneOffreTarif > formData.offreTarif) {
                    formData.tag = 'DOWNGRADE';
                } else if (formData.ancienneOffreTarif < formData.offreTarif) {
                    formData.tag = 'UPGRADE';
                }
                console.log(formData);

                if (formData.ancienneOffreTarif > formData.offreTarif && formData.offreTarif == 0) {
                    Swal.fire({
                        title: "Revenir a une offre GRATUIT",
                        text: "Vous avez choisi de revenir à l'offre gratuite. Pour valider votre choix," +
                            " cliquez sur le bouton CONFIRMER ci-dessous. Votre abonnement basculera automatiquement à " +
                            "l'échéance mensuelle de l'offre en cours.",
                        cancelButtonText: "Annuler",
                        confirmButtonText: "Confirmer",
                        showCancelButton: true,
                        reverseButtons: true,
                        focusConfirm: false,
                        confirmButtonColor: '#008779',
                        cancelButtonColor: '#262626',
                    }).then((result) => {
                        if (result.value) {
                            $.ajax({
                                url: "{{ path('app_abonnement_update_downgrade') }}",
                                type: 'POST',
                                processData: true,
                                dataType: 'json',
                                contentType: 'application/json',
                                data: JSON.stringify(formData),
                                success: function (response) {
                                    if (response.status == 200) {
                                        console.log(response);
                                        toastr.success("Mise a jour de l'abonnement effectué avec succès.");
                                        window.location = '{{ path('app_abonnement' ) }}';
                                    } else {
                                        swal.fire("Erreur!", "Un probleme est survenu", response.status);
                                    }
                                },
                                error: function (response) {
                                    swal.fire("Erreur!", "Un probleme est survenu", response.status);
                                }
                            });
                        }
                    })
                } else if (formData.offreTarif > 0) {
                    $.ajax({
                        url: "{{ path('app_abonnement_pricing_data') }}",
                        type: 'POST',
                        processData: true,
                        dataType: 'json',
                        contentType: 'application/json',
                        data: JSON.stringify(formData),
                        success: function (response) {
                            if (response.status == 200) {
                                console.log(response);
                                if (response.result.totalHt >= 0) {
                                    console.log(response.result.totalHt);
                                    window.location = formData.url;
                                } else if (response.result.totalHt < 0) {
                                    Swal.fire({
                                        title: "CHANGEMENT D'OFFRE",
                                        text: "Vous avez souhaité changer d'offre. Vous ne pouvez pas le faire dans l'immédiat. Veuillez réessayer d'ici quelques jours.",
                                        confirmButtonText: "FERMER",
                                        showCancelButton: false,
                                        reverseButtons: true,
                                        focusConfirm: false,
                                        showLoaderOnConfirm: true,
                                        confirmButtonColor: '#008779',
                                    }).then(() => {
                                        window.location = "{{ path('app_abonnement') }}";
                                    });
                                }
                            } else {
                                swal.fire("Erreur!", "Un probleme est survenu", response.status);
                            }
                        },
                        error: function (response) {
                            swal.fire("Erreur!", "Un probleme est survenu", response.status);
                        }
                    });
                }

                {% else %}
                //alert({{ app.request.headers.get('referer') }});
                    window.location = "{{ path('app_login') }}";
                {% endif %}
            });
        });
    </script>


{% endblock %}
